% ----------------------- %
% -- PACKAGES REQUIRED -- %
% ----------------------- %

\RequirePackage{calc}
\RequirePackage{etoolbox}
\RequirePackage{fancyhdr}
\RequirePackage{lastpage}
\RequirePackage{listofitems}
\RequirePackage{simplekv}
\RequirePackage{xstring}


% ------------- %
% -- OPTIONS -- %
% ------------- %

% Which style to use ?
\newcommand{\@style@choosen}{apmep}
% \newcommand{\@style@choosen}{default}
% \DeclareOption{default}{}
\DeclareOption{apmep}{\renewcommand{\@style@choosen}{apmep}}

% Which language to use ?
\newcommand{\@lang@choosen}{en}
\DeclareOption{en}{}
\DeclareOption{fr}{\renewcommand{\@lang@choosen}{fr}}

% Headers and footers or not ?
\newbool{@lyxam@show@headers@footers}
\setbool{@lyxam@show@headers@footers}{true}

\DeclareOption{hf}{}
\DeclareOption{nohf}{\setbool{@lyxam@show@headers@footers}{false}}

% Show source or not ? That is the question.
\newif\ifshowsource
\showsourcetrue

\DeclareOption{src}{}
\DeclareOption{nosrc}{\showsourcefalse}

% Show points or not ? That is the other question.
\newif\ifshowpoints
\showpointstrue

\DeclareOption{pts}{}
\DeclareOption{nopts}{\showpointsfalse}

% Sfort versions or not ? That is the big question.
\newbool{@lyxam@use@short@ctxt@name}
\setbool{@lyxam@use@short@ctxt@name}{false}

\DeclareOption{short}{\setbool{@lyxam@use@short@ctxt@name}{true}}
\DeclareOption{noshort}{}

% Processing the options
\ProcessOptions

% Loading the good language
\IfStrEqCase{\@lang@choosen}{
    {en}{\input{config/lang/en.sty}}
    {fr}{\input{config/lang/fr.sty}}
}


% == COMMON DEFINITIONS == %

% Source:
%    * https://tex.stackexchange.com/a/53091/6880
%
%    #1: value to test
%    #2: to be used if empty
%    #3: to be used if none empty
\newcommand\@if@empty[3]{%%
    \setbox0=\hbox{#1\unskip}\ifdim\wd0=0pt #2\else#3\fi%%
}


% ------------------ %
% -- KIND OF EXAM -- %
% ------------------ %

% General API Tools
\newbool{@lyxam@show@deliver}
\setbool{@lyxam@show@deliver}{false}

\newcommand\@use@lyxam@key[1]{\useKV[lyxam@keys]{#1}}

% Layout API Tools
\newcommand\@lyxam@longduration[1]{%%
    \IfStrEq{#1}{}{}{\lyxam@text@duration{}: #1}%%
}

% The general layout command.
\setKVdefault[lyxam@keys]{%
    deliver  = false, % Deliver the subject or not to the teacher
    kind     = Test,  % "Homework" for example
    nb       = {},    % Number of the exam
    subnb    = {},    % For different subjects at the same time
    subject  = {},    % "Math" for example
    theme    = {},    % "Complex Numbers" for example
    sector   = {},    % "SÃ©rie scientifique" for example
    class    = {},    % Name of a class
    location = {},    % An institute or a school
    date     = {},    % Date of the exam
    time     = {}     % Duration of the exam
}

\newcommand\exam[1][]{%
    \useKVdefault[lyxam@keys]
    \setKV[lyxam@keys]{#1}
% Boolean key
    \ifboolKV[lyxam@keys]{deliver}{%%
        \setbool{@lyxam@show@deliver}{true}%%
    }{%%
        \setbool{@lyxam@show@deliver}{false}%%
    }%%
% Other keys
    \def\@lyxam@kind{\@use@lyxam@key{kind}}%%
    \def\@lyxam@nb{\@use@lyxam@key{nb}}%%
    \def\@lyxam@subnb{\@use@lyxam@key{subnb}}%%
    \def\@lyxam@subject{\@use@lyxam@key{subject}}%%
    \def\@lyxam@theme{\@use@lyxam@key{theme}}%%
    \def\@lyxam@sector{\@use@lyxam@key{sector}}%%
    \def\@lyxam@class{\@use@lyxam@key{class}}%%
    \def\@lyxam@location{\@use@lyxam@key{location}}%%
    \def\@lyxam@date{\@use@lyxam@key{date}}%%
    \def\@lyxam@time{\@use@lyxam@key{time}}%%
    \@build@layout{}
}


% --------------- %
% -- EXERCISES -- %
% --------------- %

% General API Tools
%
% Source of the mystic unbreakable environment...
%    * https://tex.stackexchange.com/a/94702/6880
\newenvironment{absolutelynopagebreak}{%%
    \par\nobreak\vfil\penalty0\vfilneg\vtop\bgroup%%
}{%%
    \par\xdef\tpd{\the\prevdepth}\egroup\prevdepth=\tpd%%
}

% Smart counters
%
% Sources of inspiration.
%    * https://tex.stackexchange.com/a/38564/6880
%    * https://tex.stackexchange.com/a/30085/6880
%    * https://tex.stackexchange.com/q/73349/6880
\newcounter{@next@counter}

\newcommand\@build@smart@counter[1]{%
    \newcounter{#1}%%
    \setcounter{#1}{0}%%
    \newcounter{@last@#1}%%
    \newcounter{@cursor@#1}%%
    \setcounter{@cursor@#1}{0}%%
    \expandafter\gdef\csname @first@cnt@cursors@#1\endcsname{,}%%
    \expandafter\newcommand\csname smart@#1\endcsname{%%
        \refstepcounter{#1}%%
        \stepcounter{@cursor@#1}%%
        \setcounter{@last@#1}{\value{#1}}%%
% Storing cursors for inital values for the actual compilation.
        \ifnum\value{#1}=1 %%
            \immediate\write\@auxout{%%
              \string\global\string\@namedef{@cursors@#1@\the\value{@cursor@#1}}{}%%
            }%%
        \fi%%
% What do we print regarding the preceding compilation ?
        \@ifundefined{@cursors@#1@\the\value{@cursor@#1}}{%%
            \csname #1@style\endcsname{#1}%%
        }{%%
            \setcounter{@next@counter}{\value{@cursor@#1} + 1}%%
            \@ifundefined{@cursors@#1@\the\value{@next@counter}}%%
                {\csname #1@style\endcsname{#1}}%%
                {}%%
        }%%
    }%%
    \AtEndDocument{%%
% Special case of one last counter initialized.
%
% We must take care of reseting the counters : this is why we use the "last"
% counter ``@last@#1``.
        \ifnum\value{@last@#1}=1 %%
            \stepcounter{@cursor@#1}%%
            \immediate\write\@auxout{%%
              \string\global\string\@namedef{@cursors@#1@\the\value{@cursor@#1}}{}%%
            }%%
        \fi%%
    }%%
}


% Name, shorten or not, of the context
\newcommand\@lyxam@ctxt@name[1]{%%
    \ifbool{@lyxam@use@short@ctxt@name}{%%
        \csname lyxam@shorttext@#1\endcsname%%
    }{%%
        \csname lyxam@text@#1\endcsname%%
    }%%
}

\newcommand\@lyxam@if@end@with@colon[3]{%%
    \@@@lyxam@if@end@with@colon{\@lyxam@ctxt@name{#1}}{#2}{#3}%%
}

\newcommand\@@@lyxam@if@end@with@colon[3]{%%
    \IfEndWith{#1}{.}{#2}{#3}%%
}

% Number of the context
\newcommand\@lyxam@ctxt@nb[1]{%%
    \csname smart@lyxam@counter@#1\endcsname%%
}

% Long version for points
\newcommand\@lyxam@ctxt@longpoints[1]{%%
    \@if@empty{#1}{}{%%
        \IfStrEq{#1}{0}{\lyxam@text@nopoint{}}{%%
            #1 \IfStrEq{#1}{1}{\lyxam@text@point{}}{\lyxam@text@points{}}%%
        }%%
    }%%
}

% Long version of sources
%     #1: \lyxam@<CONTEXT>@source (user initial source)
\newcommand\@lyxam@ctxt@longsource[1]{%%
    \@if@empty{#1}{}{\lyxam@text@source{}: #1}%%
}

% Long version of time
%     #1: \lyxam@<CONTEXT>@time (user initial source)
\newcommand\@lyxam@ctxt@longtime[1]{%%
    \@if@empty{#1}{}{\lyxam@text@time{}: #1}%%
}

% For keys and values
\newcommand\@use@context@key[1]{\useKV[context@keys]{#1}}

% The commands for contexts
\setKVdefault[context@keys]{%
    id    = {},  % For "12 page 345" instead of an automaic number
    title = {},  % You can add an extra title
    time  = {},  % Use "no" to see only the title
    pts   = {},  % Number of points for the exercise
    src   = {},  % A short reference for a source used
    about = {}   % One additional special note
}

% Making the commands for each contexts
\newcommand\@build@values[1]{
    \useKVdefault[context@keys]%%
    \setKV[context@keys]{#1}%%
    \ifshowpoints\else\setKV[context@keys]{pts={}}\fi
    \ifshowsource\else\setKV[context@keys]{src={}}\fi
    \def\@lyxam@ctxt@id{\@use@context@key{id}}%%
    \def\@lyxam@ctxt@title{\@use@context@key{title}}%%
    \def\@lyxam@ctxt@time{\@use@context@key{time}}%%
    \def\@lyxam@ctxt@pts{\@use@context@key{pts}}%%
    \def\@lyxam@ctxt@src{\@use@context@key{src}}%%
    \def\@lyxam@ctxt@about{\@use@context@key{about}}%%
}

\newcommand\@add@context[1]{%
    \@build@smart@counter{lyxam@counter@#1}

    \expandafter\newcommand\csname#1\endcsname{%%
        \@ifstar{\csname @#1@star\endcsname}{\csname @#1@no@star\endcsname}%%
    }

% User's commands for contexts
    \expandafter\newcommand\csname @#1@star\endcsname[1][]{
        \@build@values{##1}%%
        \@if@empty{\@lyxam@ctxt@title}{
            \PackageError{lyxam}{no title and no context}{}%%
        }{}%%
        \@build@ctxt{#1}{hidectxt}%%
    }
    \expandafter\newcommand\csname @#1@no@star\endcsname[1][]{
        \@build@values{##1}%%
        \@build@ctxt{#1}{showctxt}%%
    }
}

% Let's build our contexts.
\@add@context{topic}
\newcommand\lyxam@counter@topic@style[1]{\Roman{#1}}

\@add@context{activity}
\newcommand\lyxam@counter@activity@style[1]{\arabic{#1}}
\@add@context{bonus}
\newcommand\lyxam@counter@bonus@style[1]{\arabic{#1}}
\@add@context{exercise}
\newcommand\lyxam@counter@exercise@style[1]{\arabic{#1}}
\@add@context{mcq}
\newcommand\lyxam@counter@mcq@style[1]{\arabic{#1}}
\@add@context{praticalwork}
\newcommand\lyxam@counter@praticalwork@style[1]{\arabic{#1}}
\@add@context{problem}
\newcommand\lyxam@counter@problem@style[1]{\arabic{#1}}

\@add@context{subpart}
\newcommand\lyxam@counter@subpart@style[1]{\Alph{#1}}

% Reseting of counters.
\setsepchar{,}

\newcommand\@auto@reset@by[2]{
    \readlist\parentcounters{#2}%%
    \foreachitem\onecounter\in\parentcounters{%%
        \@addtoreset{#1}{\onecounter}%%
    }%%
}

\@auto@reset@by{lyxam@counter@subpart}{lyxam@counter@topic,lyxam@counter@activity,lyxam@counter@bonus,lyxam@counter@exercise,lyxam@counter@mcq,lyxam@counter@praticalwork,lyxam@counter@problem}


% ------------- %
% -- OPTIONS -- %
% ------------- %

% Loading the good style
\IfStrEqCase{\@style@choosen}{%%
    {apmep}{\input{config/style/apmep.sty}}%%
}
