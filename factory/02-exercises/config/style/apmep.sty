% == READ ME == %

% WARNING
% -------
%
% First of all, you have to keep the following special comments :
%     * ``% == PACKAGES USED == %``
%     * ``% == DEFINITIONS == %``
%
% TODO
% ----
%
% You must several commands ``@build@<CONTEXT>`` with three semamtic levels
% where ``<CONTEXT>`` is one of the following value.
%
%     1) First level : there is only one value.
%         * "topic"
%
%     2) Second level : there are three values.
%         * "exercise"
%         * "problem"
%         * "bonus"
%
%     3) Third level : there is one value.
%         * "subpart"
%
%
% NOTE
% ----
%
%     1) The name of the actual STY file will be the name of your style.
%
%     2) The package ``fancyhdr`` is always loaded by ``lyxam``.
%
%     3) The package ``lastpage`` is always loaded by ``lyxam``.
%
%     4) For each context ``<CONTEXT>``, you can use the following constants.
%
%         i) The counter ``lyxam@<CONTEXT>@counter`` is the number of the
%            context (``lyxam`` managed level imbrications and unnumbered %            contexts for you).
%
%         ii) ``\lyxam@<CONTEXT>@text`` is the translation of the text
%             corresponding to the context ``<CONTEXT>``.
%
%         iii) For ``<KEY>`` one of the key ``id``, ``title``, ``time``,
%              ``pts``, ``src`` or ``note``, you have a corresponding
%              constant ``\lyxam@<CONTEXT>@<KEY>`` with the user's value.

%    5) The LaTeX standard boolean ``\showctxt`` indicates to show or no
%        the context.
%
%     6) One last thing, you have three useful macros with a single argument.
%
%         i) ``\@lyxam@longpoints`` builds a long version of the points
%            regarding to the language selected by the user. Here are typical
%            examples in english.
%
%             * ``\@lyxam@longpoints{ }`` returns an empty string.
%             * ``\@lyxam@longpoints{0}`` returns "No point".
%             * ``\@lyxam@longpoints{1}`` returns "1 point".
%             * ``\@lyxam@longpoints{2}`` returns "2 points".
%
%         ii) ``\lyxam@longsource`` builds a long version of the source
%            regarding to the language selected by the user. Here are typical
%            examples in english.
%
%             * ``\@lyxam@longsource{ }`` returns an empty string.
%             * ``\@lyxam@longsource{Book of the year}`` returns "Source: Book
%               of the year".
%
%         iii) ``\lyxam@longtime`` builds a long version of the time regarding
%            to the language selected by the user. Here are typical examples
%            in english.
%
%             * ``\@lyxam@longtime{ }`` returns an empty string.
%             * ``\@lyxam@longtime{20 min}`` returns "Time: 20 min".
%
% GOOD PRACTICE
% -------------
%
% For your own commands, use a prefix like ``@nameofmystyle`` such as to avoid
% conflict with global commands.


% == PACKAGES USED == %


% == DEFINITIONS == %

\makeatletter
% Spacings
    \newcommand\@apmep@space@before@topic{\par\addvspace{0.8em}}
    \newcommand\@apmep@space@before@exercise{\par\addvspace{0.8em}}
    \newcommand\@apmep@space@before@subexercise{\par\addvspace{0.7em}}

    \newcommand\@apmep@space@before@info{\par\addvspace{0.4em}}
    \newcommand\@apmep@space@before@content{\par\addvspace{0.6em}}

% Constants for center or not a part.
    \gdef\@apmep@actual@context{}
    \gdef\@apmep@centerme{yes}

% Printing context title.
%   #1 : context title
%   #2 : time
%   #3 : id
%   #4 : title
%   #5 : pts
%   #6 : space before
%   #7 : title size
    \newcommand\@apmep@print@context@title[7]{%
        #6 #7%
        \gdef\@apmep@actual@title{%
            \noindent \bfseries%
% Context with its number and title
            \ifshowctxt%
                \textsc{#1 #3}%
                \if\relax#4\relax \else%
                    : #4%
                \fi%
            \else%
% Context hidden : just the title
                #4%
            \fi%
% Time
            \if\relax#2\relax \else%
                \kern 0.7em {%
                    \normalfont \footnotesize (\lyxam@longtime{#2})%
                }%
            \fi%
% Points of the context
            \if\relax#5\relax \else%
                {\normalfont \footnotesize%
                    \IfStrEq{\@apmep@actual@context}{subpart}{%
                        \,\, [\@lyxam@longpoints{#5}]%
                    }{%
                        \hfill [\@lyxam@longpoints{#5}]%
                    }%
                }%
            \fi%
        }%
        \IfStrEq{\@apmep@actual@context}{subpart}{%
            \IfStrEq{\@apmep@centerme}{yes}{%
                \hfill\@apmep@actual@title\hfill{}
            }{%
                \@apmep@actual@title{}%
            }%
        }{%
            \@apmep@actual@title{}%
        }%
    }

% Printing note like infos.
%   #1 : text to print
%   #2 : yes or non suchas to center or not the text
%   #3 : extra tools before the text
%   #4 : \bfseries and co
%   #5 : space before
    \newcommand\@apmep@print@notelike[5]{%
        \if\relax#1\relax\else%
            #4#5\noindent#3%
            \IfStrEq{#2}{yes}{%
                \smash{\makebox[\textwidth][c]{#1\relax}}\par%
            }{%
                 #1\relax%
            }%
        \fi%
    }

% Building macros to print context titles.
%   #1 : context
%   #2 : space before context
%   #3 : space after for the incoming content
%   #4 : title size
%   #5 : note size
%   #6 : source size
    \newcommand\@apmep@add@new@context[6]{
        \expandafter\newcommand\csname @build@#1\endcsname{%
            \begin{absolutelynopagebreak}
% Some global constants
                \gdef\@apmep@actual@context{#1}%
                \IfStrEq{#1}{subpart}{}{%
                    \if\expandafter\relax\csname lyxam@#1@pts\endcsname\relax%
                        \gdef\@apmep@centerme{no}%
                    \else%
                        \gdef\@apmep@centerme{yes}%
                    \fi%
                }%
% The title of the context
                \@apmep@print@context@title{\csname lyxam@#1@text\endcsname}%
                    {\csname lyxam@#1@time\endcsname}%
                    {\csname lyxam@#1@id\endcsname}%
                    {\csname lyxam@#1@title\endcsname}%
                    {\csname lyxam@#1@pts\endcsname}%
                    {#2}{#4}%
% Notes used ?
%
%   #1 : text to print
%   #2 : yes or non suchas to center or not the text
%   #3 : extra tools before the text
%   #4 : \bfseries and co
%   #5 : space before
                \if\expandafter\relax\csname lyxam@#1@note\endcsname\relax \else%
                    \@apmep@print@notelike{\csname lyxam@#1@note\endcsname}%
                        {\@apmep@centerme}%
                        {}%
                        {#5 \bfseries \itshape}%
                        {\@apmep@space@before@info}%
                \fi%
% Source used ?
%
%   #1 : text to print
%   #2 : yes or non suchas to center or not the text
%   #3 : extra tools before the text
%   #4 : \bfseries and co
%   #5 : space before
                \if\expandafter\relax\csname lyxam@#1@src\endcsname\relax\else%
                    \@apmep@print@notelike{\lyxam@longsource\expandafter\csname lyxam@#1@src\endcsname}%
                        {\@apmep@centerme}%
                        {\hfill}%
                        {#6 \normalfont}%
                        {\@apmep@space@before@info}%
                \fi%
            \end{absolutelynopagebreak}%
% Content must go away.
            #3%
        }
    }

% The layout commands for exercices like but not for sub parts.
%   #1 : context
%   #2 : space before context
%   #3 : space after for the incoming content
%   #4 : title size
%   #5 : note size
%   #6 : source size
    \@apmep@add@new@context{topic}%
        {\@apmep@space@before@topic}%
        {\@apmep@space@before@content}%
        {\large}{\small}{\footnotesize}

    \@apmep@add@new@context{exercise}%
        {\@apmep@space@before@exercise}%
        {\@apmep@space@before@content}%
        {}{\small}{\footnotesize}
    \@apmep@add@new@context{problem}%
        {\@apmep@space@before@exercise}%
        {\@apmep@space@before@content}%
        {}{\small}{\footnotesize}
    \@apmep@add@new@context{bonus}%
        {\@apmep@space@before@exercise}%
        {\@apmep@space@before@content}%
        {}{\small}{\footnotesize}

    \@apmep@add@new@context{subpart}%
        {\@apmep@space@before@subexercise}%
        {\@apmep@space@before@content}%
        {\small}{\footnotesize}{\scriptsize}
\makeatother
