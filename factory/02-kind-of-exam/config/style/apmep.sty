% == READ ME == %

% WARNING
% -------
%
% First of all, you have to keep the following special comments :
%     * ``% == PACKAGES USED == %``
%     * ``% == DEFINITIONS == %``
%
% TODO
% ----
%
% You must define two commands :
%
%     1) ``@build@layout`` which builds the main layout.
%
%     2) ``@add@render`` which adds material where the students must give
%        their name.
%
% NOTE
% ----
%
%     1) The name of the actual STY file will be the name of your style.
%
%     2) The package ``fancyhdr`` is always loaded by ``lyxam``.
%
%     3) The package ``lastpage`` is always loaded by ``lyxam``.
%
%     4) You have the following important constants to use for the render
%        material.
%         * ``\lyxam@text@name``
%         * ``\lyxam@text@firstname``
%
%     5) You have the following important constants to use for the layout.
%         * ``\lyxam@kind``
%         * ``\lyxam@render``
%         * ``\lyxam@nb``
%         * ``\lyxam@subnb``
%         * ``\lyxam@subject``
%         * ``\lyxam@theme``
%         * ``\lyxam@sector``
%         * ``\lyxam@class``
%         * ``\lyxam@location``
%         * ``\lyxam@date``
%         * ``\lyxam@time``
%         * ``\lyxam@longduration{#1}`` (text "Duration:" plus the value of #1)
%         * ``\lyxam@preambule``
%
% GOOD PRACTICE
% -------------
%
% For your own commands, use a prefix like ``@nameofmystyle`` such as to avoid
% conflict with global commands.


% == PACKAGES USED == %

\usepackage{xstring}

\usepackage{fancyhdr}
\usepackage{lastpage}

\usepackage{tcolorbox}

\usepackage{fourier}


% == DEFINITIONS == %

\setlength{\parindent}{0cm}

% Source for same space after/before the header/footer rule :
%    * https://tex.stackexchange.com/a/375288/6880
\advance \footskip by \ht\strutbox

\makeatletter
% Tools
%
%   #1 : text before
%   #2 : separator (non-empty)
%   #3 : text after
    \newcommand\@apmep@collapse[3]{%
        \if\relax#1\relax%
            \if\relax#3\relax\else%
                #3%
            \fi%
        \else%
            \if\relax#3\relax
                #1%
            \else%
                #1#2#3%
            \fi%
        \fi%
    }

    \newcommand\@apmep@collapse@title[2]{%
        \@apmep@collapse{#1}{\, -- \,}{#2}%
    }

    \newcommand\@apmep@collapse@kind@nb@exam[2]{%
        \@apmep@collapse{#1}{\,}{#2}
    }

    \newcommand\@apmep@space@before{\par \medskip \par}

    \newcommand\@apmep@write@preambule[1]{%
        {\setlength\parindent{0pt}\small\emph{#1}}%
    }

% For the headers and the footers.
    \fancypagestyle{@apmep@first@page@style}{
        \fancyhf{}
        \renewcommand \headrulewidth{0pt}
        \renewcommand \footrulewidth{.5pt}
        \fancyfoot[C]{\footnotesize \thepage\ / \pageref{LastPage}}
    }

% The render command [START].
    \newcommand\@add@render{
        \begin{tcolorbox}[width=\linewidth]
            \medskip
            \lyxam@text@name : \hrulefill

            \bigskip
            \lyxam@text@firstname : \hrulefill

            \medskip
        \end{tcolorbox}

        \medskip
    }
% The render command [END].

% The layout command [START].
    \newcommand\@build@layout{
% Internal constants.
        \newcommand\@apmep@subject@id{%
            \if\relax \lyxam@subnb\relax \else%
                (\lyxam@subnb{})%
            \fi%
        }

        \newcommand\@apmep@exam@kind@numbered{%
            \ifnum\lyxam@nb=0%
                \lyxam@kind{}%
            \else%
                \@apmep@collapse@kind@nb@exam{\lyxam@kind{}}{\lyxam@nb{}}%
            \fi%
            \@apmep@subject@id{}%
        }

% Main title looks like "~ Homework - Math ~" (no empty main title !)
        \newcommand\@apmep@main@title{%
            \decofourleft ~
            \@apmep@collapse@title{\@apmep@exam@kind@numbered}{\lyxam@subject}%
            ~ \decofourright
        }

% The 2nd title looks like "Scientific Cursus - Complex Numbers" or nothing.
        \newcommand\@apmep@second@title{%
            \@apmep@collapse@title{\lyxam@sector}{\lyxam@theme}%
        }

% The 3rd title looks like "Name - Institute" or nothing.
        \newcommand\@apmep@third@title{%
            \@apmep@collapse@title{\lyxam@class}{\lyxam@location}%
        }

% The 4th title looks like "Date - Time" or nothing.
        \newcommand\@apmep@fourth@title{%
                \@apmep@collapse@title{\lyxam@date}{\lyxam@longduration{\lyxam@time}}%
        }

% Render or not ? That is the question !.
        \IfStrEq{\lyxam@render}{yes}{\@add@render{}}{}

% The title of the document.
        \begin{center}
            {\Large \textbf{\@apmep@main@title{}}}%
            \if\relax\@apmep@second@title\relax \else
                {\@apmep@space@before \Large \textbf{\@apmep@second@title{}}}%
            \fi
            \if\relax \@apmep@third@title\relax \else
                {\@apmep@space@before \large \textbf{\@apmep@third@title{}}}%
            \fi
            \if\relax \@apmep@fourth@title\relax \else
                \@apmep@space@before \textbf{\@apmep@fourth@title{}}%
            \fi
        \end{center}
        %
        \if\relax \lyxam@preambule\relax \else
            \@apmep@write@preambule{\lyxam@preambule{}}
        \fi

% Headers and footers
        \pagestyle{fancy}
        \renewcommand \headrulewidth{.5pt}
        \renewcommand \footrulewidth{.5pt}

        \lhead{%
            \small
            \@apmep@collapse@title{\@apmep@exam@kind@numbered}{\lyxam@theme}
        }
%        \chead{\small CENTER UP}
        \rhead{\small \@apmep@collapse@title{\lyxam@class}{\lyxam@sector}}

        \lfoot{\small \lyxam@location}
        \cfoot{\thepage\ / \pageref{LastPage}}
        \rfoot{\small \lyxam@date}

% Remember that this macro is called at the beginning of the document !
        \thispagestyle{@apmep@first@page@style}
    }
% The layout command [END].
\makeatother
