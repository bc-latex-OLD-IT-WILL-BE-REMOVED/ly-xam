% ============= %
% == READ ME == %
% ============= %
%
%
% WARNING
% -------
%
% You have to keep special comments ``% == ... == %`` where ``...`` is one
% of the following text :
%     * ``PACKAGES USED``
%     * ``DEFINITIONS``
%
% TODO
% ----
%
% You must define two commands and eventually one environment :
%
%     1) ``@build@layout`` which builds the main layout.
%
%     2) ``@add@delivery@material`` which adds material where the students must
%        give their name.
%
%     3) You can redefine the environment ``preambule``.
%
% NOTE
% ----
%
%     1) The name of the actual STY file will be the name of your style.
%
%     2) The following packages are loaded by ``lyxam``.
%         * ``calc``
%         * ``etoolbox``
%         * ``fancyhdr``
%         * ``lastpage``
%         * ``listofitems``
%         * ``simplekv``
%         * ``xstring``
%
%     3) The options used are stored in macros ``\@lyxam@<<KEY>>`` where
%        ``<<KEY>>`` is one of the option. To test if a value is an empty
%        string, you must use ``\@if@empty{\@lyxam@<<KEY>>}{TRUE}{FALSE}``.
%
%     4) Two ``etoolbox`` booleans must be managed.
%         * ``@lyxam@show@deliver`` is to know if the sheet must be delivered.
%         * ``@lyxam@show@headers@footers`` is to show or hide the headers
%           and footers.
%
%     5) You have the following important translated texts to use for the
%        delivery material.
%         * ``\lyxam@text@name``
%         * ``\lyxam@text@firstname``
%
%     6) You can also use ``\@lyxam@longduration{#1}`` which gives the text
%        "Duration:", or its translated version, followed by the value of #1.
%
% GOOD PRACTICE
% -------------
%
% For your own commands, use a prefix like ``@nameofmystyle@`` such as to avoid
% conflict with global commands.


% == PACKAGES USED == %

\usepackage{fourier-orns}
\usepackage{tcolorbox}


% == DEFINITIONS == %

\setlength{\parindent}{0cm}

% Source for same space after/before the header/footer rule :
%    * https://tex.stackexchange.com/a/375288/6880
\advance \footskip by \ht\strutbox

% Global boolean
%
% Source: https://tex.stackexchange.com/a/122641/6880
%
% Settings
\newcommand\@apmep@space@before@all@titles{\par\addvspace{2.2em}}
\newcommand\@apmep@space@after@all@titles{\par\addvspace{1.9em}}

\newcommand\@apmep@space@after@preambule{\par\addvspace{0.9em}}

\newcommand\@apmep@space@before@title{\par\addvspace{0.8em}}

\newcommand\@apmep@minus{\hspace{0.3em}--\hspace{0.3em}}

\newcommand\@apmep@lyxam@kind@numbered{}
\newcommand\@apmep@main@title{}

\newcommand\@apmep@second@title{}
\newbool{@apmep@show@second@title}

\newcommand\@apmep@third@title{}
\newbool{@apmep@show@third@title}

\newcommand\@apmep@fourth@title{}
\newbool{@apmep@show@fourth@title}

% For the headers and the footers.
\fancypagestyle{@apmep@first@page@style}{%%
    \fancyhf{}%%
    \renewcommand \headrulewidth{0pt}%%
    \renewcommand \footrulewidth{0pt}%%
    \fancyfoot[C]{\footnotesize \thepage\ / \pageref{LastPage}}%%
}

% The preambule environment to be redefined or not...
\newenvironment{preambule}%%
    {\setlength\parindent{0pt}\small\itshape}%%
    {\@apmep@space@after@preambule{}}

% Tools
\newcommand\@apmep@kind@nb@exam[2]{\@concatenate{#1}{\hspace{0.3em}}{#2}}

\newcommand\@apmep@preambule[1]{{\small\emph{#1}}}

% The delivery command [START].
\newcommand\@add@delivery@material{
    \begin{tcolorbox}[width=\linewidth]
        \medskip
        \lyxam@text@name{}: \hrulefill

        \bigskip
        \lyxam@text@firstname{} : \hrulefill

        \medskip
    \end{tcolorbox}
}
% The delivery command [END].

% The layout command [START].
\newcommand\@build@layout{
% Deliver or not ? That is the question !.
    \ifbool{@lyxam@show@deliver}{
        \@add@delivery@material{}
        \@apmep@space@before@all@titles{}
    }{}%%
% Internal constants.
    \renewcommand\@apmep@lyxam@kind@numbered{%%
        \@use@lyxam@key{kind}%%
        \@if@empty{\@lyxam@nb}{}{ \@lyxam@nb}%%
        \@if@empty{\@lyxam@subnb{}}{}{\,(\@lyxam@subnb)}%%
    }%%
% Main title looks like "~ Homework - Math ~" (no empty main title !)
    \renewcommand\@apmep@main@title{%%
        \decofourleft{}\hspace{0.3em}%%
        \@apmep@lyxam@kind@numbered{}%%
        \@if@empty{\@lyxam@subject}{}{\@apmep@minus\@lyxam@subject}%%
        \hspace{0.3em}\decofourright{}%%
    }%%
% The 2nd title looks like "Scientific Cursus - Complex Numbers" or nothing.
    \renewcommand\@apmep@second@title{%%
        \@if@empty{\@lyxam@sector}{}{\@lyxam@sector}%%
        \@if@empty{\@lyxam@theme}{}{%%
            \@if@empty{\@lyxam@sector}{\@apmep@minus}%%
            \@lyxam@theme%%
        }%%
    }%%
% The 3rd title looks like "Name - Institute" or nothing.
    \renewcommand\@apmep@third@title{%%
        \@if@empty{\@lyxam@class}{}{\@lyxam@class}%%
        \@if@empty{\@lyxam@location}{}{%%
            \@if@empty{\@lyxam@class}{}{\@apmep@minus}%%
            \@lyxam@location%%
        }%%
    }%%
% The 4th title looks like "Date - Time" or nothing.
    \renewcommand\@apmep@fourth@title{%%
        \@if@empty{\@lyxam@date}{}{\@lyxam@date}%%
        \@if@empty{\@lyxam@time}{}{%%
            \@if@empty{\@lyxam@date}{}{\@apmep@minus}%%
            \@lyxam@longduration{\@lyxam@time}%%
        }%%
    }%%
% Update all the booleans !
    \@if@empty{\@lyxam@sector}{%%
        \@if@empty{\@lyxam@theme}{%%
            \setbool{@apmep@show@second@title}{false}%%
        }{%%
            \setbool{@apmep@show@second@title}{true}%%
        }%%
    }{%%
        \setbool{@apmep@show@second@title}{true}%%
    }%%
    \@if@empty{\@lyxam@class}{%%
        \@if@empty{\@lyxam@location}{%%
            \setbool{@apmep@show@third@title}{false}%%
        }{%%
            \setbool{@apmep@show@third@title}{true}%%%%
        }%%
    }{%%
        \setbool{@apmep@show@third@title}{true}%%
    }%%
    \@if@empty{\@lyxam@date}{%%
        \@if@empty{\@lyxam@time}{%%
            \setbool{@apmep@show@fourth@title}{false}%%
        }{%%
            \setbool{@apmep@show@fourth@title}{true}%%%%
        }%%
    }{%%
        \setbool{@apmep@show@fourth@title}{true}%%
    }%%
% The title of the document.
    {\parskip=0pt\par\nopagebreak\centering
% Main title is never empty !
        {\Large \textbf{\@apmep@main@title{}}}%%
        \ifbool{@apmep@show@second@title}{
            \@apmep@space@before@title{}
            {\Large \textbf{\@apmep@second@title{}}}%%
        }{}%%
        \ifbool{@apmep@show@third@title}{%%
            \@apmep@space@before@title{}
            {\large \textbf{\@apmep@third@title{}}}%%
        }{}%%
        \ifbool{@apmep@show@fourth@title}{%%
            \@apmep@space@before@title{}
            \textbf{\@apmep@fourth@title{}}%%
        }{}%%
        \par\ignorespacesafterend
    }%%
    \@apmep@space@after@all@titles{}%%
% Headers and footers
    \ifbool{@lyxam@show@headers@footers}{%%
        \pagestyle{fancy}
        \renewcommand\headrulewidth{.5pt}
        \renewcommand\footrulewidth{.5pt}
        \lhead{%
            \small\@apmep@lyxam@kind@numbered{}%%
            \@if@empty{\@lyxam@theme}{}{\@apmep@minus\@lyxam@theme}%%
        }
%        \chead{\small CENTER UP}
        \rhead{%%
            \small%%
            \@if@empty{\@lyxam@class}{}{\@lyxam@class}%%
            \@if@empty{\@lyxam@sector}{}{%%
                \@if@empty{\@lyxam@class}{}{\@apmep@minus}%%
                \@if@empty{\@lyxam@sector}{}{\@lyxam@sector}%%
            }
        }%%
        \lfoot{%%
            \small%%
            \@if@empty{\@lyxam@location}{}{\@lyxam@location}%%
        }%%
        \cfoot{\footnotesize \thepage\ / \pageref{LastPage}}
        \rfoot{%%
            \small%%
            \@if@empty{\@lyxam@date}{}{\@lyxam@date}%%
        }%%
% Remember that this macro is called at the beginning of the document !
        \thispagestyle{@apmep@first@page@style}%%
    }{}%%
}
% The layout command [END].
