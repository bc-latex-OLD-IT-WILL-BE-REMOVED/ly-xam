% == PACKAGES USED == %

\RequirePackage{changepage}
\RequirePackage{fancyhdr}
\RequirePackage{lastpage}

\RequirePackage{calc}
\RequirePackage{etoolbox}
\RequirePackage{listofitems}
\RequirePackage{simplekv}
\RequirePackage{xstring}


% == COMMON SETTINGS == %

% Which style to use ?
\newcommand{\@style@choosen}{apmep}
% \newcommand{\@style@choosen}{default}
% \DeclareOption{default}{}
\DeclareOption{apmep}{\renewcommand{\@style@choosen}{apmep}}

% Which language to use ?
\newcommand{\@lang@choosen}{en}
\DeclareOption{en}{}
\DeclareOption{fr}{\renewcommand{\@lang@choosen}{fr}}


% == LOCAL SETTINGS == %

% Headers and footers or not ?
\newbool{@lyxam@show@headers@footers}
\setbool{@lyxam@show@headers@footers}{true}

\DeclareOption{hf}{}
\DeclareOption{nohf}{\setbool{@lyxam@show@headers@footers}{false}}


% == PROCESSING OPTION - LOADING LANG == %

% Processing the options
\ProcessOptions

% Loading the good language
\IfStrEqCase{\@lang@choosen}{
    {en}{\input{config/lang/en.sty}}%
    {fr}{\input{config/lang/fr.sty}}
}


% == COMMON DEFINITIONS == %

% Source:
%    * https://tex.stackexchange.com/a/53091/6880
%
%    #1: value to test
%    #2: used if empty
%    #3: used if none empty
\newcommand\@if@empty[3]{%%
    \setbox0=\hbox{#1\unskip}\ifdim\wd0=0pt #2\else#3\fi%%
}

\newcommand\@use@lyxam@key[1]{\useKV[lyxam@title@keys]{#1}}
\newcommand\@use@lyxam@preamble@key[1]{\useKV[lyxam@preamble@keys]{#1}}


% == LOCAL DEFINITIONS == %

% Layout tools
\newcommand\@lyxam@longduration[1]{%%
    \IfStrEq{#1}{}{}{\lyxam@text@duration{}: #1}%%
}

% Deliver or not ?
\newbool{@lyxam@show@deliver}
\setbool{@lyxam@show@deliver}{false}

% The general layout command.
\setKVdefault[lyxam@title@keys]{%
    deliver  = no,    % Deliver the subject or not to the teacher
    kind     = Test,  % "Homework" for example
    nb       = {},    % Number of the exam
    subnb    = {},    % For different subjects at the same time
    subject  = {},    % "Math" for example
    theme    = {},    % "Complex Numbers" for example
    sector   = {},    % "SÃ©rie scientifique" for example
    class    = {},    % Name of a class
    location = {},    % An institute or a school
    date     = {},    % Date of the exam
    time     = {}     % Duration of the exam
}

\newcommand\exam[1][]{%%
    \useKVdefault[lyxam@title@keys]%%
    \setKV[lyxam@title@keys]{#1}%%
% User's values
    \def\@lyxam@deliver{\@use@lyxam@key{deliver}}%%
    \def\@lyxam@kind{\@use@lyxam@key{kind}}%%
    \def\@lyxam@nb{\@use@lyxam@key{nb}}%%
    \def\@lyxam@subnb{\@use@lyxam@key{subnb}}%%
    \def\@lyxam@subject{\@use@lyxam@key{subject}}%%
    \def\@lyxam@theme{\@use@lyxam@key{theme}}%%
    \def\@lyxam@sector{\@use@lyxam@key{sector}}%%
    \def\@lyxam@class{\@use@lyxam@key{class}}%%
    \def\@lyxam@location{\@use@lyxam@key{location}}%%
    \def\@lyxam@date{\@use@lyxam@key{date}}%%
    \def\@lyxam@time{\@use@lyxam@key{time}}%%
% Good deliver option ?     TODO
% The style can work now.
    \@build@layout{}
}

% The preamble environment
%
% Soource:
%    * https://tex.stackexchange.com/a/32707/6880
%    * https://tex.stackexchange.com/a/149046/6880

% \newenvironment{preamble}[2][1]{%%
% % Basic style additional formatting of the text.
%     \begin{@preamble@style}
% % Center ?
%     \IfStrEq{#2}{center}{\centering}{}%%
% % Width
%     \setlength{\@@@lyxam@preamble@margin}{%%
%         \dimexpr(\linewidth - #1\linewidth)/2\relax%%
%     }
%     % \begin{minipage}{}
%     \begin{adjustwidth}{\@@@lyxam@preamble@margin}{\@@@lyxam@preamble@margin}
% }{%%
%     % \end{minipage}
%     \end{adjustwidth}
%     \end{@preamble@style}
% }


\newlength{\@@@lyxam@preamble@margin}

\setKVdefault[lyxam@preamble@keys]{%
    center = false,   %% Center or not the preamble
    scale  = 1 %% Line width ofr the premabules.
}

\newenvironment{preamble}[1][]{%%
% Basic style additional formatting of the text.
    \begin{@preamble@style}%%
% Optional parameters
    \useKVdefault[lyxam@preamble@keys]%%
    \setKV[lyxam@preamble@keys]{#1}%%
% Width
    \def\@lyxam@premabule@scale{\@use@lyxam@preamble@key{scale}}%%
    \setlength{\@@@lyxam@preamble@margin}{%%
        \dimexpr(\linewidth - \@lyxam@premabule@scale\linewidth)/2\relax%%
    }%%
    \begin{adjustwidth}{\@@@lyxam@preamble@margin}{\@@@lyxam@preamble@margin}
% Center ?
    \ifboolKV[lyxam@preamble@keys]{center}{\centering}{}%%
}{%%
    % \end{minipage}
    \end{adjustwidth}
    \end{@preamble@style}
}

% == LOADING THE STYLE == %

% Loading the good style
\IfStrEqCase{\@style@choosen}{
    {apmep}{\input{config/style/apmep.sty}}%
}

% == END == %
