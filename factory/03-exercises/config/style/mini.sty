% == PACKAGES USED == %

\RequirePackage{bigfoot}


% == DEFINITIONS == %

% Spacings
\newcommand\@mini@space@before@topic{\par\addvspace{1.8em}}
\newcommand\@mini@space@before@exercise{\par\addvspace{0.85em}}
\newcommand\@mini@space@before@subexercise{\par\addvspace{0.75em}}

\newcommand\@mini@space@before@info{\par\addvspace{0.5em}}
\newcommand\@mini@space@before@content{\par\addvspace{0.5em}}

% Special footnotes for sources
\DeclareNewFootnote{src}
\MakeSortedPerPage{footnotesrc}
\renewcommand\thefootnotesrc{%%
    \raisebox{0.08em}{$\lceil$}\alph{footnotesrc}\raisebox{-0.05em}{$\rfloor$}%%
}

% General builder for all contexts
%     #1: name of the context
%     #2: ``hidectxt`` or ``showctxt`
\newcommand\@build@ctxt[2]{%%
    \def\@mini@ctxt@pts{%%
        \@if@empty{\@lyxam@ctxt@pts}{}{%%
            [\,\@lyxam@ctxt@longpoints{\@lyxam@ctxt@pts}\,]%%
        }%%
    }%%
    \def\@mini@ctxt@time{%%
        \@if@empty{\@lyxam@ctxt@time}{}{%%
            (\@lyxam@ctxt@longtime{\@lyxam@ctxt@time})%%
        }%%
    }%%
    \def\@mini@ctxt@src{\@lyxam@ctxt@longsource{\@lyxam@ctxt@src}}%%
% Settings of the context
    \IfStrEq{#1}{topic}{%%
        \def\@mini@title@format{\normalsize\bfseries}%%
        \def\@mini@title@centering{\centering}%%
        \def\@mini@title@inside{\kern 0.8em}%%
        \def\@mini@about@format{\itshape\small}%%
    }{%%
        \IfStrEq{#1}{subpart}{%%
            \def\@mini@title@format{\small}%%
            \def\@mini@title@centering{\centering}%%
            \def\@mini@title@inside{\kern 0.8em}%%
            \def\@mini@about@format{\itshape\footnotesize}%%
        }{%%
            \def\@mini@title@format{\normalsize\bfseries}%%
            \def\@mini@title@centering{}%%
            \def\@mini@title@inside{\hfill}%%
            \def\@mini@about@format{\itshape\small\noindent}%%
        }%%
    }%%
% Printing the context, time and points.
%
% Warning ! Sub exercises and topics are always centered.
    \IfStrEq{#1}{subpart}{%%
        \@mini@space@before@subexercise%%
    }{%%
        \IfStrEq{#1}{topic}{%%
            \@mini@space@before@topic%%
        }{%%
            \@mini@space@before@exercise%%
        }
    }%%
% Build context title.
    \IfStrEq{#2}{showctxt}{%%
        \gdef\@mini@ctxt@title{%%
            \textsc{%%
                \gdef\ctxtname{\@lyxam@ctxt@name{#1}}%%
                \ctxtname%%
                \@lyxam@if@end@with@colon{#1}{}{~}%%
                \@if@empty\@lyxam@ctxt@id{\@lyxam@ctxt@nb{#1}}{\@lyxam@ctxt@id}%%
                \@if@empty\@lyxam@ctxt@title{}{: \@lyxam@ctxt@title}%%
            }%%
        }%%
    }{%%
        \gdef\@mini@ctxt@title{\textsc{\@lyxam@ctxt@title}}%%
    }%%
% Build time and points.
    \gdef\@mini@ctxt@title@extra{%%
        \normalfont\scriptsize%%
        \@concatenate{\@mini@ctxt@time}{\kern 0.8em}{\@mini@ctxt@pts}%%
    }%%
    {%%
% The contexts.
        \noindent\@mini@title@format\@mini@title@centering%%
        \@mini@ctxt@title{}%%
% Source as a footnote.
        \@if@empty\@mini@ctxt@src{}{%%
            \,\,\footnotesrc{\,\,\@mini@ctxt@src}%%
        }%%
% Time and points
        \@mini@title@inside{}\@mini@ctxt@title@extra%%
% About note.
        \@if@empty\@lyxam@ctxt@about{\par}{%%
            \@mini@space@before@info
            {\@mini@title@centering\@mini@about@format\@lyxam@ctxt@about\par}%%
        }%%
    }%%
    \@mini@space@before@content%%
}
