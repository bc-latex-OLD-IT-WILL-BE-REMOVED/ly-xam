% ============= %
% == READ ME == %
% ============= %
%
%
% WARNING
% -------
%
% You have to keep special comments ``% == ... == %`` where ``...`` is one
% of the following text :
%     * ``PACKAGES USED``
%     * ``DEFINITIONS``
%
% TODO
% ----
%
% You must define on single command ``\@build@ctxt`` whith two arguments.
%
%     1) Argument #1 is he kind of context: ``topic``, ``exercise``...
%
%     2) Argument #2 is either ``hidectxt`` or ``showctxt`` so has to show
%        or hide the text for the context.
%        Just use ``\IfStrEq{#2}{hidectxt}{HIDE}{SHOW}`` in your code.
%
% NOTE
% ----
%
%     1) The name of the actual STY file will be the name of your style.
%
%     2) The following packages are loaded by ``lyxam``.
%         * ``calc``
%         * ``fancyhdr``
%         * ``lastpage``
%         * ``listofitems``
%         * ``simplekv``
%         * ``xstring``
%
%     3) The options used are stored in macros ``\@exam@ctxt@<<KEY>>`` where
%        ``<<KEY>>`` if one of the option but you must use
%        ``\@if@val@empty{\@exam@ctxt@<<KEY>>}{TRUE}{FALSE}``
%        if you want to know if the value is empty or not (this is because
%        ``simplekv`` uses ``true`` as a default value).
%
%     4) Two booleans must be managed.
%         * ``showsource`` is to show or hide the source used.
%         * ``showpoints`` is to show or hide the points.
%
%
%     4) To print the number of the context, just use
%        ``\@exam@ctxt@nb{<<CTX>>}`` where ``<<CTX>>`` is the name of
%        the context.
%
%     6) You can also use the following command where ``<<CTX>>`` is the name
%        of the context.
%
%         * ``\@exam@ctxt@longpoints{<<CTX>>}`` gives either nothing, or
%           "No point", or "1 point" or "X points".
%
%         * ``\@exam@ctxt@longpsource{<<CTX>>}`` gives either nothing, or
%           "Source:...".
%
%         * ``\@exam@ctxt@longptime{<<CTX>>}`` gives either nothing, or
%           "Time:...".
%
% GOOD PRACTICE
% -------------
%
% For your own commands, use a prefix like ``@nameofmystyle`` such as to avoid
% conflict with global commands.


% == PACKAGES USED == %


% == DEFINITIONS == %

% Spacings
\newcommand\@apmep@space@before@topic{\par\addvspace{1.8em}}
\newcommand\@apmep@space@before@exercise{\par\addvspace{1.8em}}
\newcommand\@apmep@space@before@subexercise{\par\addvspace{0.9em}}

\newcommand\@apmep@space@before@info{\par\addvspace{0.4em}}
\newcommand\@apmep@space@before@content{\par\addvspace{0.6em}}

% For center or not the subexercises.
\newif\ifapmepcentersubex
\apmepcentersubextrue

% General builder for all contexts
%     #1: name of the context
%     #2: "showctxt" otr "hidectxt"
\newcommand\@build@ctxt[2]{%%
    \def\@apmep@exam@ctxt@pts{\@exam@ctxt@longpoints{\@exam@ctxt@pts}}%%
    \def\@apmep@exam@ctxt@time{\@exam@ctxt@longtime{\@exam@ctxt@time}}%%
    \def\@apmep@exam@ctxt@src{\@exam@ctxt@longsource{\@exam@ctxt@src}}%%
% Settings of the context
    \IfStrEq{#1}{topic}{%%
        \def\@apmep@title@size{\large}%%
        \def\@apmep@about@size{\small}%%
        \def\@apmep@source@size{\footnotesize}%%
    }{%%
        \IfStrEq{#1}{subpart}{%%
            \def\@apmep@title@size{\small}%%
            \def\@apmep@about@size{\footnotesize}%%
            \def\@apmep@source@size{\scriptsize}%%
        }{%%
            \def\@apmep@title@size{}%%
            \def\@apmep@about@size{\small}%%
            \def\@apmep@source@size{\footnotesize}%%
        }%%
    }%%
% Centered or not ?
    \IfStrEq{#1}{subpart}{%%
        \apmepcentersubextrue%%
    }{%%
        \@if@val@empty{\@exam@ctxt@pts}%%
            {\apmepcentersubexfalse}%%
            {\apmepcentersubextrue}%%
    }
% Printing the context, time and points.
%
% Warning ! Sub exercises are always centered.
    \IfStrEq{#1}{subpart}{\@apmep@space@before@subexercise}{\@apmep@space@before@exercise}
    \begin{absolutelynopagebreak}
        \IfStrEq{#2}{hidectxt}{%%
            \gdef\@apmep@ctxt@title{%%
                \textsc{%%
                    \@if@val@empty{\@exam@ctxt@title}{}{\@exam@ctxt@title}%%
                }%%
            }%%
        }{%%
            \gdef\@apmep@ctxt@title{%%
                \textsc{%%
                    \csname lyxam@text@#1\endcsname{}
                    \@if@val@empty{\@exam@ctxt@id}{\@exam@ctxt@nb{#1}}{\@exam@ctxt@id}%%
                    \@if@val@empty{\@exam@ctxt@title}{}{: \@exam@ctxt@title}%%
                }%%
            }%%
        }%%
% Time and points.
        \gdef\@apmep@ctxt@title@extra{%%
            {\normalfont\scriptsize%%
                \@if@val@empty{\@exam@ctxt@time}{}{%%
                    \kern 0.8em (\@apmep@exam@ctxt@time)%%
                }%%
                \@if@val@empty{\@exam@ctxt@pts}{}{%%
                    \IfStrEq{#1}{subpart}{\kern 0.8em}{\hfill}
                    [\,\@apmep@exam@ctxt@pts{}\,]%%
                }%%
            }%%
        }%%
        {\noindent\bfseries\@apmep@title@size%%
            \IfStrEq{#1}{subpart}{%%
                \smash{\makebox[\textwidth][c]{\@apmep@ctxt@title{}\@apmep@ctxt@title@extra{}}}%%
            }{%%
                \@apmep@ctxt@title{}\@apmep@ctxt@title@extra{}%%
            }%%
        }%%
% About note.
        \@if@val@empty{\@exam@ctxt@about}{}{%%
            \@apmep@space@before@info
            {\bfseries\itshape\@apmep@about@size%%
                \ifapmepcentersubex%%
                    \smash{\makebox[\textwidth][c]{\@exam@ctxt@about}}%%
                \else%%
                    \noindent\@exam@ctxt@about%%
                \fi%%
            }%%
        }%%
% Source.
        \@if@val@empty{\@exam@ctxt@src}{}{%%
            \@apmep@space@before@info
            {\normalfont\@apmep@source@size%%
                \ifapmepcentersubex%%
                    \smash{\makebox[\textwidth][c]{\@apmep@exam@ctxt@src}}%%
                \else%%
                    \hfill\@apmep@exam@ctxt@src%%
                \fi%%
            }%%
        }%%
    \end{absolutelynopagebreak}%%
    \@apmep@space@before@content%%
}
