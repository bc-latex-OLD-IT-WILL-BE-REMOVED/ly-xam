% == PACKAGES USED == %


% == DEFINITIONS == %

% Spacings
\newcommand\@apmep@space@before@topic{\par\addvspace{2.5em}}
\newcommand\@apmep@space@before@exercise{\par\addvspace{1.5em}}
\newcommand\@apmep@space@before@subexercise{\par\addvspace{0.8em}}

\newcommand\@apmep@space@before@info{\par\addvspace{0.4em}}
\newcommand\@apmep@space@before@content{\par\addvspace{0.6em}}

% For center or not the subexercises.
\newbool{@apmep@center@subexercise}
\setbool{@apmep@center@subexercise}{true}

% General builder for all contexts
%     #1: name of the context
%     #2: ``hidectxt`` or ``showctxt`
\newcommand\@build@ctxt[2]{%%
    \def\@apmep@ctxt@pts{\@lyxam@ctxt@longpoints{\@lyxam@ctxt@pts}}%%
    \def\@apmep@ctxt@time{\@lyxam@ctxt@longtime{\@lyxam@ctxt@time}}%%
    \def\@apmep@ctxt@src{\@lyxam@ctxt@longsource{\@lyxam@ctxt@src}}%%
% Settings of the context
    \IfStrEq{#1}{topic}{%%
        \def\@apmep@title@size{\large}%%
        \def\@apmep@about@size{\small}%%
        \def\@apmep@source@size{\footnotesize}%%
    }{%%
        \IfStrEq{#1}{subpart}{%%
            \def\@apmep@title@size{\small}%%
            \def\@apmep@about@size{\footnotesize}%%
            \def\@apmep@source@size{\scriptsize}%%
        }{%%
            \def\@apmep@title@size{}%%
            \def\@apmep@about@size{\small}%%
            \def\@apmep@source@size{\footnotesize}%%
        }%%
    }%%
% Centered or not ?
    \IfStrEq{#1}{subpart}{%%
        \setbool{@apmep@center@subexercise}{true}%%
    }{%%
        \@if@empty\@lyxam@ctxt@pts{%%
            \setbool{@apmep@center@subexercise}{false}%%
        }{%%
            \setbool{@apmep@center@subexercise}{true}%%
        }%%
    }
% Printing the context, time and points.
%
% Warning ! Sub exercises are always centered.
    \IfStrEq{#1}{subpart}{%%
        \@apmep@space@before@subexercise%%
    }{%%
        \IfStrEq{#1}{topic}%%
            {\@apmep@space@before@topic}%%
            {\@apmep@space@before@exercise}%%
    }%%
    \begin{absolutelynopagebreak}
% Build context title.
        \IfStrEq{#2}{showctxt}{%%
            \gdef\@apmep@ctxt@title{%%
                \textsc{%%
                    \gdef\ctxtname{\@lyxam@ctxt@name{#1}}%%
                    \ctxtname%%
                    \@lyxam@if@end@with@colon{#1}{}{~}%%
                    \@if@empty\@lyxam@ctxt@id{\@lyxam@ctxt@nb{#1}}{\@lyxam@ctxt@id}%%
                    \@if@empty\@lyxam@ctxt@title{}{: \@lyxam@ctxt@title}%%
                }%%
            }%%
        }{%%
            \gdef\@apmep@ctxt@title{\textsc{\@lyxam@ctxt@title}}%%
        }%%
% Build time and points.
        \gdef\@apmep@ctxt@title@extra{%%
            {\normalfont\scriptsize%%
                \@if@empty\@lyxam@ctxt@time{}{%%
                    \kern 0.8em (\@apmep@ctxt@time)%%
                }%%
                \@if@empty\@lyxam@ctxt@pts{}{%%
                    \IfStrEq{#1}{subpart}{\kern 0.8em}{\hfill}
                    [\,\@apmep@ctxt@pts{}\,]%%
                }%%
            }%%
        }%%
% Write context title.
        {\noindent\bfseries\@apmep@title@size%%
            \IfStrEq{#1}{subpart}{%%
                \smash{\makebox[\textwidth][c]{\@apmep@ctxt@title{}\@apmep@ctxt@title@extra{}}}%%
            }{%%
                \@apmep@ctxt@title{}\@apmep@ctxt@title@extra{}%%
            }%%
        }%%
% Write about note.
        \@if@empty\@lyxam@ctxt@about{}{%%
            \@apmep@space@before@info
            {\bfseries\itshape\@apmep@about@size%%
                \ifbool{@apmep@center@subexercise}{%%
                    \smash{\makebox[\textwidth][c]{\@lyxam@ctxt@about}}%%
                }{%%
                    \noindent\@lyxam@ctxt@about%%
                }%%
            }%%
        }%%
% Write source.
        \@if@empty\@lyxam@ctxt@src{}{%%
            \@apmep@space@before@info
            {\normalfont\@apmep@source@size%%
                \ifbool{@apmep@center@subexercise}{%%
                    \smash{\makebox[\textwidth][c]{\@apmep@ctxt@src}}%%
                }{%%
                    \hfill\@apmep@ctxt@src%%
                }%%
            }%%
        }%%
    \end{absolutelynopagebreak}%%
    \@apmep@space@before@content%%
}
