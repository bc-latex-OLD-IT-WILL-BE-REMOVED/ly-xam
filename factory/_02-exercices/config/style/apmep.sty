% == READ ME == %

% TODO
% ----
%
% You must define a command @build@layout which has the same structure than
% the command exam in layout.sty. The automatic Python builder will add this
% minimalistic code for you.
%
% NOTE
% ----
%
%    1) The name of the actual STY file will be the name of your style.
%    2) ``\@apmep@nb@exam`` and ``\@apmep@kind@exam`` can't be both empty.
%    3) The package ``fancyhdr`` is always loaded by ``lyxam``.
%    4) The package ``lastpage`` is always loaded by ``lyxam``.
%
% GOOD PRACTICE
% -------------
%
% For your own commands, use a prefix like ``@nameofmystyle`` such
% as to avoid conflict with global commands.


% == PACKAGES USED == %

\usepackage{pgfkeys}

\usepackage{fancyhdr}
\usepackage{lastpage}

\usepackage{fourier}


% == DEFINITIONS == %

% Source for same space after/before the header/footer rule :
%    * https://tex.stackexchange.com/a/375288/6880
\advance \footskip by \ht\strutbox

\makeatletter
% Tools
    \newcommand\@apmep@collapse[3]{%
        #1%
        \if\relax #1\relax \else
            \if\relax #3\relax \else
                #2%
            \fi
        \fi
        #3%@
    }

    \newcommand\@apmep@collapse@title[2]{%
        \@apmep@collapse{#1}{\, -- \,}{#2}
    }

    \newcommand\@apmep@collapse@kind@nb@exam[2]{%
        \@apmep@collapse{#1}{\,}{#2}
    }

    \newcommand\@apmep@space@before{\par \medskip \par}
    \newcommand\@apmep@space@after{\par \bigskip \par}

    \newcommand\@apmep@write@preambule[1]{%
        {\small\emph{#1}}%
    }

% For the headers and the footers.
    \fancypagestyle{@apmep@first@page@style}{
        \fancyhf{}
        \renewcommand \headrulewidth{0pt}
        \renewcommand \footrulewidth{.5pt}
        \fancyfoot[C]{\footnotesize \thepage\ / \pageref{LastPage}}
    }


% Setting of the keys for the formatting and the infos of the @exam.
    \pgfkeys{
        /@apmep@examkeys/.is family,
        /@apmep@examkeys,
            nb/.initial        = 0,  % Number of the exam
            subnb/.initial     = {}, % For different subjects at the same time
            kind/.initial      = {}, % "Homework" for example
            subject/.initial   = {}, % "Math" for example
            theme/.initial     = {}, % "Complex Numbers" for example
            sector/.initial    = {}, % "SÃ©rie scientifique" for example
            class/.initial     = {}, % Name of a class
            location/.initial  = {}, % An institute or a school
            date/.initial      = {}, % Date of the exam
            time/.initial      = {}, % Duration of the exam
            longtime/.initial  = {}, % Text "Duration:" plus the value of time
            preambule/.initial = {}, % Main preambule
            @firstuse/.initial = 0
    }

% The layout command [START].
    \newcommand\@build@layout[1][]{%
        \pgfkeys{/@apmep@examkeys, #1}
        \pgfkeysgetvalue{/@apmep@examkeys/nb}{\@apmep@nb@exam}
        \pgfkeysgetvalue{/@apmep@examkeys/subnb}{\@apmep@subnb@exam}
        \pgfkeysgetvalue{/@apmep@examkeys/kind}{\@apmep@kind@exam}
        \pgfkeysgetvalue{/@apmep@examkeys/subject}{\@apmep@subject@exam}
        \pgfkeysgetvalue{/@apmep@examkeys/theme}{\@apmep@theme@exam}
        \pgfkeysgetvalue{/@apmep@examkeys/sector}{\@apmep@sector@exam}
        \pgfkeysgetvalue{/@apmep@examkeys/class}{\@apmep@class@exam}
        \pgfkeysgetvalue{/@apmep@examkeys/location}{\@apmep@location@exam}
        \pgfkeysgetvalue{/@apmep@examkeys/date}{\@apmep@date@exam}
        \pgfkeysgetvalue{/@apmep@examkeys/time}{\@apmep@time@exam}
        \pgfkeysgetvalue{/@apmep@examkeys/longtime}{\@apmep@longtime@exam}
        \pgfkeysgetvalue{/@apmep@examkeys/preambule}{\@apmep@preambule@exam}

% The layout command [CUSTOMIZATION].

% Internal constants.
        \newcommand\@apmep@subject@id{%
            \if\relax \@apmep@subnb@exam\relax \else
                (\@apmep@subnb@exam{})%
            \fi
        }

        \newcommand\@apmep@kind@exam@numbered{%
            \ifnum\@apmep@nb@exam=0
                \@apmep@kind@exam{}%
            \else
                \@apmep@collapse@kind@nb@exam{\@apmep@kind@exam{}}{\@apmep@nb@exam{}}%
            \fi
            \@apmep@subject@id{}%
        }

% Main title looks like "~ Homework - Math ~" (no empty main title !)
        \newcommand\@apmep@main@title{%
            \decofourleft ~%
            \@apmep@collapse@title{\@apmep@kind@exam@numbered{}}{\@apmep@subject@exam{}}%
            ~ \decofourright
        }

% The 2nd title looks like "Scientific Cursus - Complex Numbers" or nothing.
        \newcommand\@apmep@second@title{%
            \@apmep@collapse@title{\@apmep@sector@exam{}}{\@apmep@theme@exam{}}%
        }

% The 3rd title looks like "Name - Institute" or nothing.
        \newcommand\@apmep@third@title{%
            \@apmep@collapse@title{\@apmep@class@exam{}}{\@apmep@location@exam{}}%
        }

% The 4th title looks like "Date - Time" or nothing.
        \newcommand\@apmep@fourth@title{%
            \@apmep@collapse@title{\@apmep@date@exam{}}{\@apmep@longtime@exam{}}%
        }

% The title of the document.
        \begin{center}
            {\Large \textbf{\@apmep@main@title{}}}%
            \if\relax\@apmep@second@title\relax \else
                {\@apmep@space@before \Large \textbf{\@apmep@second@title{}}}%
            \fi
            \if\relax \@apmep@third@title\relax \else
                {\@apmep@space@before \large \textbf{\@apmep@third@title{}}}%
            \fi
            \if\relax \@apmep@fourth@title\relax \else
                \@apmep@space@before \textbf{\@apmep@fourth@title{}}%
            \fi
        \end{center}
        %
        \if\relax \@apmep@preambule@exam\relax \else
            \@apmep@write@preambule{\@apmep@preambule@exam{}}
        \fi
        \@apmep@space@after

% Headers and footers
        \pagestyle{fancy}
        \renewcommand \headrulewidth{.5pt}
        \renewcommand \footrulewidth{.5pt}

        \lhead{%
            \small
            \@apmep@collapse@title{\@apmep@kind@exam@numbered{}}{\@apmep@theme@exam{}}
        }
%        \chead{\small CENTER UP}
        \rhead{\small \@apmep@collapse@title{\@apmep@class@exam}{\@apmep@sector@exam}}

        \lfoot{\small \@apmep@location@exam}
        \cfoot{\thepage\ / \pageref{LastPage}}
        \rfoot{\small \@apmep@date@exam}

% Remember that this macro is called at the beginning of the document !
        \thispagestyle{@apmep@first@page@style}
    }
% The layout command [END].
\makeatother
