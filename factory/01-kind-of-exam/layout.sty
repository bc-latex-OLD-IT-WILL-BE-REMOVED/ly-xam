% == PACKAGES USED == %

\usepackage{pgfkeys}
\usepackage{xstring}


% == DEFINITIONS == %

\makeatletter
% Which style to use ?
    \newcommand{\@style@choosen}{default}
    \DeclareOption{default}{}
    \DeclareOption{apmep}{\renewcommand{\@style@choosen}{apmep}}

% Which language to use ?
    \newcommand{\@lang@choosen}{en}
    \DeclareOption{en}{}
    \DeclareOption{fr}{\renewcommand{\@lang@choosen}{fr}}

% Processing the options
    \ProcessOptions

% Loading the good language
    \IfStrEqCase{\@lang@choosen}{
        {en}{
            \input{config/lang/en.sty}
        }{fr}{
            \input{config/lang/fr.sty}
        }
    }

% Setting of the keys for the formatting and the infos of the @exam.
    \pgfkeys{
        /examkeys/.is family,
        /examkeys,
            nb/.initial        = 0,  % Number of the exam
            subnb/.initial     = {}, % For different subjects at the same time
            kind/.initial      = {}, % "Homework" for example
            subject/.initial   = {}, % "Math" for example
            theme/.initial     = {}, % "Complex Numbers" for example
            sector/.initial    = {}, % "SÃ©rie scientifique" for example
            class/.initial     = {}, % Name of a class
            location/.initial  = {}, % An institute or a school
            date/.initial      = {}, % Date of the exam
            time/.initial      = {}, % Duration of the exam
            preambule/.initial = {}, % Main preambule
            @firstuse/.initial = 0
    }

% The general layout command.
    \newcommand\exam[1][]{%
% User's options
        \pgfkeys{/examkeys, #1}
        \pgfkeysgetvalue{/examkeys/@firstuse}{\@firstuse}

% First use ?
        \ifnum\@firstuse=1
            \PackageError{lyxam}{command 'exam' can be used only one time}
        \fi
        \pgfkeyssetvalue{/examkeys/@firstuse}{1}

% Management of the keys.
        \pgfkeysgetvalue{/examkeys/nb}{\@nb@exam}
        \pgfkeysgetvalue{/examkeys/subnb}{\@subnb@exam}
        \pgfkeysgetvalue{/examkeys/kind}{\@kind@exam}
        \pgfkeysgetvalue{/examkeys/subject}{\@subject@exam}
        \pgfkeysgetvalue{/examkeys/theme}{\@theme@exam}
        \pgfkeysgetvalue{/examkeys/sector}{\@sector@exam}
        \pgfkeysgetvalue{/examkeys/class}{\@class@exam}
        \pgfkeysgetvalue{/examkeys/location}{\@location@exam}
        \pgfkeysgetvalue{/examkeys/date}{\@date@exam}
        \pgfkeysgetvalue{/examkeys/time}{\@time@exam}
        \pgfkeysgetvalue{/examkeys/preambule}{\@preambule@exam}

% Make the long time version.
        \newcommand\@longtime@exam{
	        \if\relax\@time@exam\relax \else
	        	\examduration{} : \@time@exam{}
	    	\fi
		}

% Building the layout.
        \@build@layout[%
            nb        = \@nb@exam,%
            subnb     = \@subnb@exam,%
            kind      = \@kind@exam,%
            subject   = \@subject@exam,%
            theme     = \@theme@exam,%
            sector    = \@sector@exam,%
            class     = \@class@exam,%
            location  = \@location@exam,%
            date      = \@date@exam,%
            time      = \@time@exam,%
            longtime  = \@longtime@exam,% Text "Duration:" plus the value of time
            preambule = \@preambule@exam,%
        ]
    }


% Loading the good style
    \IfStrEqCase{\@style@choosen}{
        {apmep}{
            \input{config/style/apmep.sty}
        }{default}{
            \PackageError{lyxam}{no default layout for the moment}
        }
    }
\makeatother
